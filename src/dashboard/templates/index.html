<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Receipt Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  </head>
  <body class="p-4">
    <h1>Receipts</h1>
    <form action="/upload" method="post" enctype="multipart/form-data" class="mb-3">
      <input type="file" name="receipt" required multiple>
      <button class="btn btn-primary" type="submit">Upload</button>
    </form>
    {% for g in groups %}
      {% if g.id %}
        <h3 class="mt-4">Batch {{ g.title }} <span class="badge bg-secondary ms-2">{{ g.items|length }}{% if g.batch_total %}/{{ g.batch_total }}{% endif %}</span></h3>
      {% else %}
        <h3 class="mt-4">Other</h3>
      {% endif %}
      {% for f in g.items %}
      <div class="mb-4">
        <h2>{{ f.name }}</h2>
        <p>Job Name: {{ f.data.job_name or 'N/A' }}</p>
        <p>Total: {{ f.data.total or 'N/A' }}</p>
        <pre>{{ f.data.raw_text }}</pre>
      </div>
      {% endfor %}
    {% endfor %}
  {% if any_processing %}
  <script>
    (function () {
      const INTERVAL_MS = 5000;
      let editing = false;

      function isFormActive() {
        if (editing) return true;
        if (document.querySelector('details[open]')) return true;
        const ae = document.activeElement;
        if (!ae) return false;
        const tag = ae.tagName;
        if (ae.isContentEditable) return true;
        if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return true;
        return !!ae.closest('form');
      }

      // Track whether user has interacted with any form
      document.addEventListener('focusin', (e) => {
        if (e.target && e.target.closest('form')) editing = true;
      });
      document.addEventListener('focusout', () => {
        // Recompute after blur whether any form element still focused
        setTimeout(() => {
          editing = !!document.querySelector('form :focus');
        }, 0);
      });

      setInterval(() => {
        if (!isFormActive()) {
          location.reload();
        }
      }, INTERVAL_MS);
    })();
  </script>
  {% endif %}
  </body>
</html>
