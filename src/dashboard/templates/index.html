<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>Receipt Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  </head>
  <body class="p-4">
    <h1 class="d-flex justify-content-between align-items-center">
      <span>Receipts</span>
      <a class="btn btn-outline-secondary btn-sm" href="{{ url_for('reports') }}">View Reports</a>
    </h1>
    <form action="/upload" method="post" enctype="multipart/form-data" class="mb-3">
      <input type="file" name="receipt" required multiple>
      <button class="btn btn-primary" type="submit">Upload</button>
    </form>
    {% for g in groups %}
      {% if g.id %}
        <h3 class="mt-4">Batch {{ g.title }} <span class="badge bg-secondary ms-2">{{ g['items']|length }}{% if g.batch_total %}/{{ g.batch_total }}{% endif %}</span></h3>
      {% else %}
        <h3 class="mt-4">Other</h3>
      {% endif %}
      {% for f in g['items'] %}
      <div class="mb-4">
        <h2 class="d-flex justify-content-between align-items-center">
          <span>
            {{ f.name }}
            {% if f.data.batch_seq %}
              <span class="badge bg-secondary ms-2">#{{ f.data.batch_seq }}{% if f.data.batch_total %}/{{ f.data.batch_total }}{% endif %}</span>
            {% endif %}
          </span>
          <a class="btn btn-link btn-sm" href="{{ url_for('classify', name=f.id) }}">Edit</a>
        </h2>
        {% if f.data.status == 'processing' %}
          <div class="text-muted">Processing...</div>
        {% endif %}
        <p>Job Name: {{ f.data.job_name or 'N/A' }}</p>
        <p>Category: {{ f.data.category or 'N/A' }}</p>
        <p>Total: {{ f.data.total if f.data.total is not none else 'N/A' }}</p>
        {% set needs_fix = (not f.data.job_name) or (f.data.total is none) %}
        {% if needs_fix %}
          <div class="alert alert-warning p-2 mt-2">
            <div class="d-flex justify-content-between align-items-center">
              <div><strong>Missing data.</strong> Provide Job Name and/or Total.</div>
              <a class="btn btn-link btn-sm" href="{{ url_for('classify', name=f.id) }}">Open full form</a>
            </div>
            <form class="row g-2 mt-1" method="post" action="{{ url_for('classify', name=f.id) }}">
              <div class="col-sm-4">
                <input class="form-control form-control-sm" name="job_name" placeholder="Job name" value="{{ f.data.job_name or '' }}">
              </div>
              <div class="col-sm-3">
                <input class="form-control form-control-sm" name="total" placeholder="Total (e.g., 49.47)" value="{{ f.data.total if f.data.total is not none else '' }}">
              </div>
              <div class="col-sm-3">
                <select class="form-select form-select-sm" name="category">
                  <option value="" {% if not f.data.category %}selected{% endif %}>— Category —</option>
                  <option value="fuel" {% if f.data.category == 'fuel' %}selected{% endif %}>Fuel</option>
                </select>
              </div>
              <div class="col-sm-2">
                <button class="btn btn-primary btn-sm w-100" type="submit">Save</button>
              </div>
            </form>
          </div>
        {% endif %}
        <details class="mt-2">
          <summary>Quick edit</summary>
          <form class="row g-2 mt-1" method="post" action="{{ url_for('classify', name=f.id) }}">
            <div class="col-sm-4">
              <input class="form-control form-control-sm" name="job_name" placeholder="Job name" value="{{ f.data.job_name or '' }}">
            </div>
            <div class="col-sm-3">
              <input class="form-control form-control-sm" name="total" placeholder="Total (e.g., 49.47)" value="{{ f.data.total if f.data.total is not none else '' }}">
            </div>
            <div class="col-sm-3">
              <select class="form-select form-select-sm" name="category">
                <option value="" {% if not f.data.category %}selected{% endif %}>— Category —</option>
                <option value="fuel" {% if f.data.category == 'fuel' %}selected{% endif %}>Fuel</option>
              </select>
            </div>
            <div class="col-sm-2">
              <button class="btn btn-primary btn-sm w-100" type="submit">Save</button>
            </div>
          </form>
          <div class="form-text">Tip: use the Edit page for a stable view if the list is auto-refreshing during processing.</div>
        </details>
        {% if f.data.raw_text %}
        <details>
          <summary>Show OCR text</summary>
          <pre style="white-space: pre-wrap">{{ f.data.raw_text }}</pre>
        </details>
        {% endif %}
      </div>
      {% endfor %}
    {% endfor %}
  {% if any_processing %}
  <script>
    (function () {
      const INTERVAL_MS = 5000;
      let editing = false;

      function isFormActive() {
        if (editing) return true;
        if (document.querySelector('details[open]')) return true;
        const ae = document.activeElement;
        if (!ae) return false;
        const tag = ae.tagName;
        if (ae.isContentEditable) return true;
        if (tag === 'INPUT' || tag === 'TEXTAREA' || tag === 'SELECT') return true;
        return !!ae.closest('form');
      }

      // Track whether user has interacted with any form
      document.addEventListener('focusin', (e) => {
        if (e.target && e.target.closest('form')) editing = true;
      });
      document.addEventListener('focusout', () => {
        // Recompute after blur whether any form element still focused
        setTimeout(() => {
          editing = !!document.querySelector('form :focus');
        }, 0);
      });

      setInterval(() => {
        if (!isFormActive()) {
          location.reload();
        }
      }, INTERVAL_MS);
    })();
  </script>
  {% endif %}
  </body>
</html>
